import React, { useState, useEffect } from 'react';\nimport {\n  View,\n  Text,\n  TouchableOpacity,\n  ScrollView,\n  ActivityIndicator,\n} from 'react-native';\nimport { useRouter } from 'expo-router';\nimport { useCartStore, useOrderStore, useUserStore } from '../../src/store';\nimport { Feather } from '@expo/vector-icons';\n\nexport default function CheckoutScreen() {\n  const router = useRouter();\n  const { items, totalPrice, deliveryFee } = useCartStore();\n  const { createOrder, isLoading } = useOrderStore();\n  const { addresses, getAddresses } = useUserStore();\n  const [selectedAddress, setSelectedAddress] = useState<string | null>(null);\n  const [selectedPayment, setSelectedPayment] = useState<'card' | 'cash'>('card');\n  const [isProcessing, setIsProcessing] = useState(false);\n\n  useEffect(() => {\n    getAddresses();\n  }, []);\n\n  const tax = Math.round(totalPrice * 0.1);\n  const total = totalPrice + deliveryFee + tax;\n\n  const handlePlaceOrder = async () => {\n    if (!selectedAddress) {\n      alert('Please select a delivery address');\n      return;\n    }\n\n    setIsProcessing(true);\n    try {\n      const address = addresses.find(a => a.id === selectedAddress);\n      if (!address) return;\n\n      const order = await createOrder({\n        items,\n        deliveryAddress: address,\n        paymentMethod: selectedPayment,\n        totalAmount: total,\n        deliveryFee,\n      });\n\n      if (order) {\n        router.replace(`/(customer)/OrderTracking?orderId=${order.id}`);\n      }\n    } finally {\n      setIsProcessing(false);\n    }\n  };\n\n  if (!addresses.length) {\n    return (\n      <View className=\"flex-1 bg-white\">\n        <View className=\"px-6 py-4 border-b border-gray-200 flex-row items-center\">\n          <TouchableOpacity onPress={() => router.back()} className=\"mr-4\">\n            <Feather name=\"chevron-left\" size={24} color=\"#1F2937\" />\n          </TouchableOpacity>\n          <Text className=\"text-2xl font-bold text-gray-900\">Checkout</Text>\n        </View>\n        <View className=\"flex-1 items-center justify-center\">\n          <ActivityIndicator size=\"large\" color=\"#16A34A\" />\n        </View>\n      </View>\n    );\n  }\n\n  return (\n    <View className=\"flex-1 bg-white\">\n      {/* Header */}\n      <View className=\"px-6 py-4 border-b border-gray-200 flex-row items-center\">\n        <TouchableOpacity onPress={() => router.back()} className=\"mr-4\">\n          <Feather name=\"chevron-left\" size={24} color=\"#1F2937\" />\n        </TouchableOpacity>\n        <Text className=\"text-2xl font-bold text-gray-900\">Checkout</Text>\n      </View>\n\n      <ScrollView className=\"flex-1\">\n        {/* Delivery Address */}\n        <View className=\"px-6 py-6 border-b border-gray-200\">\n          <Text className=\"text-lg font-bold text-gray-900 mb-4\">Delivery Address</Text>\n          {addresses.map(address => (\n            <TouchableOpacity\n              key={address.id}\n              onPress={() => setSelectedAddress(address.id)}\n              className={`border-2 rounded-lg p-4 mb-3 flex-row items-center ${\n                selectedAddress === address.id\n                  ? 'border-green-600 bg-green-50'\n                  : 'border-gray-200'\n              }`}\n            >\n              <View className=\"flex-1\">\n                <Text className=\"text-lg font-semibold text-gray-900 mb-1\">\n                  {address.type.toUpperCase()}\n                </Text>\n                <Text className=\"text-gray-600\">\n                  {address.street}, {address.city}\n                </Text>\n                <Text className=\"text-gray-500 text-sm\">\n                  {address.state}, {address.zipCode}\n                </Text>\n              </View>\n              {selectedAddress === address.id && (\n                <Feather name=\"check-circle\" size={24} color=\"#16A34A\" />\n              )}\n            </TouchableOpacity>\n          ))}\n          <TouchableOpacity\n            onPress={() => router.push('/(customer)/AddLocation')}\n            className=\"border-2 border-dashed border-gray-300 rounded-lg p-4 items-center\"\n          >\n            <Feather name=\"plus\" size={24} color=\"#9CA3AF\" />\n            <Text className=\"text-gray-600 font-semibold mt-2\">Add New Address</Text>\n          </TouchableOpacity>\n        </View>\n\n        {/* Payment Method */}\n        <View className=\"px-6 py-6 border-b border-gray-200\">\n          <Text className=\"text-lg font-bold text-gray-900 mb-4\">Payment Method</Text>\n          <TouchableOpacity\n            onPress={() => setSelectedPayment('card')}\n            className={`border-2 rounded-lg p-4 mb-3 flex-row items-center ${\n              selectedPayment === 'card'\n                ? 'border-green-600 bg-green-50'\n                : 'border-gray-200'\n            }`}\n          >\n            <Feather name=\"credit-card\" size={24} color={selectedPayment === 'card' ? '#16A34A' : '#9CA3AF'} />\n            <View className=\"flex-1 ml-4\">\n              <Text className=\"text-lg font-semibold text-gray-900\">Credit/Debit Card</Text>\n              <Text className=\"text-gray-600 text-sm\">Visa, Mastercard</Text>\n            </View>\n            {selectedPayment === 'card' && (\n              <Feather name=\"check-circle\" size={24} color=\"#16A34A\" />\n            )}\n          </TouchableOpacity>\n\n          <TouchableOpacity\n            onPress={() => setSelectedPayment('cash')}\n            className={`border-2 rounded-lg p-4 flex-row items-center ${\n              selectedPayment === 'cash'\n                ? 'border-green-600 bg-green-50'\n                : 'border-gray-200'\n            }`}\n          >\n            <Feather name=\"dollar-sign\" size={24} color={selectedPayment === 'cash' ? '#16A34A' : '#9CA3AF'} />\n            <View className=\"flex-1 ml-4\">\n              <Text className=\"text-lg font-semibold text-gray-900\">Cash on Delivery</Text>\n              <Text className=\"text-gray-600 text-sm\">Pay when order arrives</Text>\n            </View>\n            {selectedPayment === 'cash' && (\n              <Feather name=\"check-circle\" size={24} color=\"#16A34A\" />\n            )}\n          </TouchableOpacity>\n        </View>\n\n        {/* Order Summary */}\n        <View className=\"px-6 py-6\">\n          <Text className=\"text-lg font-bold text-gray-900 mb-4\">Order Summary</Text>\n          <View className=\"bg-gray-50 rounded-lg p-4 gap-3\">\n            <View className=\"flex-row items-center justify-between\">\n              <Text className=\"text-gray-600\">Subtotal</Text>\n              <Text className=\"text-gray-900 font-semibold\">{totalPrice}K</Text>\n            </View>\n            <View className=\"flex-row items-center justify-between\">\n              <Text className=\"text-gray-600\">Tax (10%)</Text>\n              <Text className=\"text-gray-900 font-semibold\">{tax}K</Text>\n            </View>\n            <View className=\"flex-row items-center justify-between\">\n              <Text className=\"text-gray-600\">Delivery Fee</Text>\n              <Text className=\"text-gray-900 font-semibold\">{deliveryFee}K</Text>\n            </View>\n            <View className=\"border-t border-gray-200 pt-3 flex-row items-center justify-between\">\n              <Text className=\"text-lg font-bold text-gray-900\">Total</Text>\n              <Text className=\"text-2xl font-bold text-green-600\">{total}K</Text>\n            </View>\n          </View>\n        </View>\n      </ScrollView>\n\n      {/* Place Order Button */}\n      <View className=\"px-6 py-6 border-t border-gray-200 bg-white\">\n        <TouchableOpacity\n          onPress={handlePlaceOrder}\n          disabled={isProcessing || isLoading || !selectedAddress}\n          className={`rounded-lg py-4 flex-row items-center justify-center ${\n            isProcessing || isLoading || !selectedAddress ? 'bg-gray-300' : 'bg-green-600'\n          }`}\n        >\n          {isProcessing || isLoading ? (\n            <ActivityIndicator color=\"white\" />\n          ) : (\n            <Text className=\"text-white text-center font-bold text-lg\">Place Order</Text>\n          )}\n        </TouchableOpacity>\n      </View>\n    </View>\n  );\n}\n
