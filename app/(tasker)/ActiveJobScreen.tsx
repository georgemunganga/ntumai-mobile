import React, { useState, useEffect } from 'react';\nimport {\n  View,\n  Text,\n  TouchableOpacity,\n  ScrollView,\n  Alert,\n  Dimensions,\n} from 'react-native';\nimport { useRouter, useRoute } from 'expo-router';\nimport { Ionicons } from '@expo/vector-icons';\nimport { locationService } from '../../src/services/location';\n\nconst { width } = Dimensions.get('window');\n\ninterface JobStep {\n  id: string;\n  title: string;\n  description: string;\n  completed: boolean;\n  timestamp?: string;\n}\n\nexport default function ActiveJobScreen() {\n  const router = useRouter();\n  const route = useRoute();\n  const { jobId } = route.params as any;\n\n  const [currentLocation, setCurrentLocation] = useState<any>(null);\n  const [isTracking, setIsTracking] = useState(false);\n  const [steps, setSteps] = useState<JobStep[]>([\n    {\n      id: '1',\n      title: 'Navigate to Pickup',\n      description: 'Head to the pickup location',\n      completed: false,\n    },\n    {\n      id: '2',\n      title: 'Arrive at Pickup',\n      description: 'Confirm arrival at pickup location',\n      completed: false,\n    },\n    {\n      id: '3',\n      title: 'Collect Items',\n      description: 'Collect items from customer',\n      completed: false,\n    },\n    {\n      id: '4',\n      title: 'Navigate to Dropoff',\n      description: 'Head to the dropoff location',\n      completed: false,\n    },\n    {\n      id: '5',\n      title: 'Deliver Items',\n      description: 'Deliver items to customer',\n      completed: false,\n    },\n  ]);\n\n  const jobData = {\n    jobId,\n    pickupLocation: 'Downtown Market',\n    pickupAddress: '123 Main St, Downtown',\n    dropoffLocation: 'Residential Area',\n    dropoffAddress: '456 Oak Ave, Suburbs',\n    customerName: 'John Doe',\n    customerPhone: '+1 (555) 123-4567',\n    estimatedEarnings: 2.5,\n    distance: 3.2,\n    status: 'in_progress',\n  };\n\n  useEffect(() => {\n    startTracking();\n    return () => {\n      locationService.stopTracking();\n    };\n  }, []);\n\n  const startTracking = async () => {\n    const location = await locationService.getCurrentLocation();\n    if (location) {\n      setCurrentLocation(location);\n      setIsTracking(true);\n\n      // Start continuous tracking\n      await locationService.startTracking((location) => {\n        setCurrentLocation(location);\n      });\n    }\n  };\n\n  const handleCompleteStep = (stepId: string) => {\n    setSteps(\n      steps.map((step) =>\n        step.id === stepId\n          ? {\n              ...step,\n              completed: true,\n              timestamp: new Date().toLocaleTimeString(),\n            }\n          : step\n      )\n    );\n  };\n\n  const handleArriveAtPickup = () => {\n    Alert.alert('Confirm Arrival', 'Are you at the pickup location?', [\n      { text: 'Cancel', style: 'cancel' },\n      {\n        text: 'Confirm',\n        onPress: () => {\n          handleCompleteStep('2');\n          Alert.alert('Success', 'Arrival confirmed. Collect items from customer.');\n        },\n      },\n    ]);\n  };\n\n  const handleCollectItems = () => {\n    Alert.alert('Collect Items', 'Have you collected all items?', [\n      { text: 'No', style: 'cancel' },\n      {\n        text: 'Yes',\n        onPress: () => {\n          handleCompleteStep('3');\n          Alert.alert('Success', 'Items collected. Head to dropoff location.');\n        },\n      },\n    ]);\n  };\n\n  const handleDelivery = () => {\n    Alert.alert('Confirm Delivery', 'Have you delivered all items?', [\n      { text: 'No', style: 'cancel' },\n      {\n        text: 'Yes',\n        onPress: () => {\n          handleCompleteStep('5');\n          Alert.alert('Success', 'Delivery completed! Job finished.', [\n            {\n              text: 'View Earnings',\n              onPress: () => {\n                router.push('/(tasker)/EarningsScreen');\n              },\n            },\n          ]);\n        },\n      },\n    ]);\n  };\n\n  const handleCancelJob = () => {\n    Alert.alert(\n      'Cancel Job',\n      'Are you sure you want to cancel this job? This may affect your rating.',\n      [\n        { text: 'Keep Job', style: 'cancel' },\n        {\n          text: 'Cancel Job',\n          onPress: () => {\n            router.back();\n          },\n          style: 'destructive',\n        },\n      ]\n    );\n  };\n\n  const completedSteps = steps.filter((s) => s.completed).length;\n  const progress = (completedSteps / steps.length) * 100;\n\n  return (\n    <View className=\"flex-1 bg-white\">\n      {/* Header */}\n      <View className=\"bg-white border-b border-gray-200 px-4 py-4 flex-row items-center justify-between\">\n        <View>\n          <Text className=\"text-2xl font-bold text-gray-900\">Active Job</Text>\n          <Text className=\"text-sm text-gray-600 mt-1\">Job ID: {jobId}</Text>\n        </View>\n        <TouchableOpacity\n          onPress={handleCancelJob}\n          className=\"p-2\"\n        >\n          <Ionicons name=\"close\" size={24} color=\"#EF4444\" />\n        </TouchableOpacity>\n      </View>\n\n      <ScrollView className=\"flex-1 px-4 py-4\" showsVerticalScrollIndicator={false}>\n        {/* Progress */}\n        <View className=\"mb-6\">\n          <View className=\"flex-row justify-between items-center mb-2\">\n            <Text className=\"text-sm font-semibold text-gray-900\">Progress</Text>\n            <Text className=\"text-sm text-gray-600\">{completedSteps}/{steps.length}</Text>\n          </View>\n          <View className=\"h-2 bg-gray-200 rounded-full overflow-hidden\">\n            <View\n              className=\"h-full bg-green-500\"\n              style={{ width: `${progress}%` }}\n            />\n          </View>\n        </View>\n\n        {/* Current Location */}\n        {currentLocation && (\n          <View className=\"bg-blue-50 rounded-lg p-4 mb-6 border border-blue-200\">\n            <Text className=\"text-sm text-blue-900 font-semibold mb-2\">üìç Current Location</Text>\n            <Text className=\"text-xs text-blue-700\">\n              Lat: {currentLocation.latitude.toFixed(4)}, Lon: {currentLocation.longitude.toFixed(4)}\n            </Text>\n          </View>\n        )}\n\n        {/* Job Details */}\n        <View className=\"bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200\">\n          <Text className=\"text-lg font-bold text-gray-900 mb-4\">Job Details</Text>\n\n          {/* Pickup */}\n          <View className=\"mb-4\">\n            <View className=\"flex-row items-start mb-2\">\n              <View className=\"w-6 h-6 rounded-full bg-green-500 items-center justify-center mr-3 mt-0.5\">\n                <Text className=\"text-white text-xs\">üìç</Text>\n              </View>\n              <View className=\"flex-1\">\n                <Text className=\"text-sm text-gray-600\">Pickup</Text>\n                <Text className=\"text-base font-semibold text-gray-900\">\n                  {jobData.pickupLocation}\n                </Text>\n                <Text className=\"text-xs text-gray-600 mt-1\">\n                  {jobData.pickupAddress}\n                </Text>\n              </View>\n            </View>\n          </View>\n\n          {/* Divider */}\n          <View className=\"ml-3 mb-4 border-l-2 border-gray-300 h-4\" />\n\n          {/* Dropoff */}\n          <View className=\"mb-4\">\n            <View className=\"flex-row items-start\">\n              <View className=\"w-6 h-6 rounded-full bg-red-500 items-center justify-center mr-3 mt-0.5\">\n                <Text className=\"text-white text-xs\">üìç</Text>\n              </View>\n              <View className=\"flex-1\">\n                <Text className=\"text-sm text-gray-600\">Dropoff</Text>\n                <Text className=\"text-base font-semibold text-gray-900\">\n                  {jobData.dropoffLocation}\n                </Text>\n                <Text className=\"text-xs text-gray-600 mt-1\">\n                  {jobData.dropoffAddress}\n                </Text>\n              </View>\n            </View>\n          </View>\n\n          {/* Earnings */}\n          <View className=\"flex-row justify-between items-center p-3 bg-white rounded-lg border border-gray-200 mt-4\">\n            <Text className=\"text-gray-600 font-semibold\">Estimated Earnings</Text>\n            <Text className=\"text-2xl font-bold text-green-600\">\n              ‚Ç≠{jobData.estimatedEarnings}\n            </Text>\n          </View>\n        </View>\n\n        {/* Steps */}\n        <Text className=\"text-lg font-bold text-gray-900 mb-3\">Delivery Steps</Text>\n        {steps.map((step, index) => (\n          <View key={step.id} className=\"mb-3\">\n            <TouchableOpacity\n              onPress={() => {\n                if (step.id === '2') handleArriveAtPickup();\n                else if (step.id === '3') handleCollectItems();\n                else if (step.id === '5') handleDelivery();\n              }}\n              disabled={step.completed}\n              className={`p-4 rounded-lg border-2 ${\n                step.completed\n                  ? 'bg-green-50 border-green-300'\n                  : 'bg-white border-gray-200'\n              }`}\n            >\n              <View className=\"flex-row items-start\">\n                <View\n                  className={`w-6 h-6 rounded-full items-center justify-center mr-3 mt-0.5 ${\n                    step.completed ? 'bg-green-500' : 'bg-gray-300'\n                  }`}\n                >\n                  {step.completed ? (\n                    <Ionicons name=\"checkmark\" size={16} color=\"white\" />\n                  ) : (\n                    <Text className=\"text-white text-xs font-bold\">{index + 1}</Text>\n                  )}\n                </View>\n                <View className=\"flex-1\">\n                  <Text\n                    className={`font-semibold ${\n                      step.completed ? 'text-green-900' : 'text-gray-900'\n                    }`}\n                  >\n                    {step.title}\n                  </Text>\n                  <Text\n                    className={`text-sm mt-1 ${\n                      step.completed ? 'text-green-700' : 'text-gray-600'\n                    }`}\n                  >\n                    {step.description}\n                  </Text>\n                  {step.timestamp && (\n                    <Text className=\"text-xs text-green-600 mt-1\">\n                      Completed at {step.timestamp}\n                    </Text>\n                  )}\n                </View>\n              </View>\n            </TouchableOpacity>\n          </View>\n        ))}\n\n        {/* Customer Info */}\n        <View className=\"bg-gray-50 rounded-lg p-4 mt-6 border border-gray-200\">\n          <Text className=\"text-lg font-bold text-gray-900 mb-3\">Customer Info</Text>\n          <View className=\"flex-row items-center justify-between mb-3\">\n            <Text className=\"text-gray-900 font-semibold\">{jobData.customerName}</Text>\n            <TouchableOpacity className=\"p-2 bg-green-500 rounded-full\">\n              <Ionicons name=\"call\" size={20} color=\"white\" />\n            </TouchableOpacity>\n          </View>\n          <Text className=\"text-sm text-gray-600\">{jobData.customerPhone}</Text>\n        </View>\n      </ScrollView>\n    </View>\n  );\n}\n
